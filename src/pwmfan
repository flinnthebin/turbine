#!/usr/bin/env bash
# setpwm: enable manual PWM control and set values for two channels
# Usage: sudo ./setpwm /sys/class/hwmon/.../pwm1 180 /sys/class/hwmon/.../pwm2 200

set -euo pipefail

usage() { echo "Usage: sudo $0 <pwm1_value 0-255>"; exit 1; }

[[ $# -eq 1 ]] || usage
p1="/sys/class/hwmon/hwmon4/pwm1"; v1="$3";
#p2="/sys/class/hwmon/hwmon4/pwm2"; v2="$4"  ## TODO: not writable

clamp() {
  local x=$1
  (( x < 0 )) && x=0
  (( x > 255 )) && x=255
  printf '%d\n' "$x"
}

set_one() {
  local pwm="$1" val
  val="$(clamp "$2")"
  [[ -w "$pwm" ]] || { echo "Not writable: $pwm"; exit 1; }
  [[ -w "${pwm}_enable" ]] && echo 1 > "${pwm}_enable"   # manual mode
  echo "$val" > "$pwm"
  echo "Set $(basename "$pwm") to $val"
}

set_one "$p1" "$v1"
#set_one "$p2" "$v2"
